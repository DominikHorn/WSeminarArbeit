<!DOCTYPE html>
<!-- saved from url=(0048)http://www.redblobgames.com/articles/visibility/ -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><title>2d Visibility</title><link rel="canonical" href="./2d Visibility_files/2d Visibility.html"><link rel="alternate" type="application/atom+xml" title="Blobs in Games - Atom" href="http://simblob.blogspot.com/feeds/posts/default"><meta name="verify-v1" content="82b+h1+tgwLrcTqTiJrqquMvoFVBwMwY11dx63m01zk="><meta name="robots" content="noodp"><link href="https://fonts.gstatic.com/" rel="preconnect" crossorigin="crossorigin"><link href="https://fonts.googleapis.com/css?family=Roboto+Slab:700%7COpen+Sans%27%20rel=%27stylesheet"><link href="http://disqus.com/embed/comments/" rel="preconnect"><link href="http://a.disquscdn.com/" rel="preconnect"><meta name="viewport" content="width=500"><link rel="shortcut icon" href="http://www.redblobgames.com/favicon.ico"><link rel="apple-touch-icon" href="http://www.redblobgames.com/red%20blob%202d.png"><script async="" type="text/javascript" src="./2d Visibility_files/ga.js"></script><script async="" type="text/javascript" src="./2d Visibility_files/gap.min.js"></script><script><!--
            (function() {
            var link = document.createElement('link');
            link.href = 'http://fonts.googleapis.com/css?family=Source+Code+Pro:400,700|Source+Sans+Pro:400,400italic,700italic,700';
            link.rel = 'stylesheet';
            link.type = 'text/css';
            if (document.location.hostname != 'localhost') document.getElementsByTagName('html')[0].appendChild(link);
            })();
          //--></script><style>
              body{font-family:"Source Sans Pro", "Open Sans", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Tahoma", sans-serif;font-size:14px;line-height:1.5;min-height:95%}body.width600{font-size:16px}tt,code,kbd,samp,pre{font-family:"Source Code Pro", monospace, serif, "Segoe UI Symbol", "Symbol";font-size:12px;font-size-adjust:none}.width600 tt,.width600 code,.width600 kbd,.width600 samp,.width600 pre{font-size:14px}nav{font-size:14px}header,h2{text-shadow:0px 2px 5px rgba(0,0,0,0.8);text-rendering:optimizeLegibility;-webkit-font-feature-settings:"kern";-moz-font-feature-settings:"kern";-moz-font-feature-settings:"liga=1,pnum=1,onum=1,kern=1";-ms-font-feature-settings:"liga" 1, "pnum" 1, "onum" 1, "kern" 1;font-kerning:normal}h1{font-size:28px}h1 .subheading{letter-spacing:normal;font-size:14px}.width600 h1{font-size:32px}.width600 h1 .subheading{font-size:16px}sup,sub{position:relative;vertical-align:baseline;font-size:75%;line-height:0;padding-left:2px}sup{top:-0.5em}sub{bottom:-0.25em}*{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}html,body{margin:0;padding:0}body{background-color:#fff;color:#333}.main{max-width:1075px;margin-left:auto;margin-right:auto;padding:0 40px}header{display:block;text-align:center}h1{margin:0;padding:28px;padding-left:80px;text-align:left}.colored-background{color:#fff;background-color:#bf4040}header,.footer,.divider,h2{color:#fff;background-color:#bf4040;-webkit-font-smoothing:antialiased}header a,.footer a,.divider a,h2 a{color:#f2d8d8}.footer a,.divider a{text-decoration:underline}.comments,.divider-disqus{background-color:#e4e4e0}.comments{padding-bottom:20px;text-shadow:1px 1px 3px #fff}h2{margin:20px 0;padding:10px 40px;font-size:20px;max-width:530px}.width600 h2{max-width:680px}h2 a.anchor{float:right;width:2em;text-align:right;color:#bf4040}h2:hover a.anchor{color:#df9f9f}h3{margin:18px 0;font-size:18px}nav{display:block}nav ul{text-align:center;line-height:1.0;margin:0}nav ul li{display:inline-block;padding:2px 5px;text-align:center;width:10%;white-space:nowrap}nav ul li a{display:block;width:100%;font-weight:bold;text-decoration:none}nav ul li.nav:hover{background-color:rgba(0,0,0,0.5);font-weight:bold}nav ul li.navself{background-color:rgba(0,0,0,0.3);font-weight:bold}.topic{margin-left:40px;margin-right:40px;margin-bottom:35px;max-width:450px}.width600 .topic{max-width:600px}header,.divider,h2{border-bottom:1px solid #000}.divider,.footer,h2{border-top:1px solid #000}.divider{min-height:28px;padding-left:2.5em}.divider-disqus{padding-top:14px;text-align:center}.footer{clear:both;padding:7px 14px;border-top:1px solid #000}h2:target{-webkit-animation:target-attention 0.4s 1;-moz-animation:target-attention 0.4s 1}@-webkit-keyframes target-attention{0%{-webkit-transform:scale(1.1);transform:scale(1.1)}100%{-webkit-transform:scale(1);transform:scale(1.1)}}@-moz-keyframes target-attention{0%{-moz-transform:scale(1.1);transform:scale(1.1)}100%{-moz-transform:scale(1);transform:scale(1)}}h2:target{font-size:24px}div:target{border:1px dashed #888}kbd kbd{padding:1px 7px;margin:0px 1px 3px 1px;display:inline-block;font-size:11px;font-family:"Helvetica Neue", "Helvetica", "Tahoma", "Arial", sans-serif;white-space:nowrap;background:#ddd;color:#242;border:1px solid rgba(0,0,0,0.2);border-radius:3px;box-shadow:inset 0 0 1px 1px #fff,0 2px 0 rgba(0,0,0,0.3)}samp,kbd{background-color:#f4f4f0}code,samp{color:#442}kbd{margin:0 7px;color:#252}.topic>img{max-width:100%;-ms-interpolation-mode:bicubic}.topic figcaption{font-size:12px;text-align:center}a{color:#bf4040;text-decoration:none}a:hover{text-decoration:underline}.topic p,.topic li{text-align:justify;-moz-hyphens:auto;-ms-hyphens:auto;-webkit-hyphens:auto;hyphens:auto}nav,figure,abbr,acronym,code,kbd,samp,tt,var,pre{-moz-hyphens:none;-ms-hyphens:none;-webkit-hyphens:none;hyphens:none}p,ul,ol,ul.spaced>li,ol.spaced>li{margin:1.25em 0}ul ul,ul ol,ol ul,ol ol,li ul,li ol{margin:0}ul,ol{margin-left:0;padding-left:21px}dt{font-weight:bold}pre{max-width:450px;line-height:1.4;font-size:12px;padding:4px 12px;overflow:auto;white-space:pre-wrap;border-top:1px solid #ccc;border-bottom:1px solid #ccc;border-left-width:0;border-right-width:0}.width600 pre{max-width:600px}.width600 pre{font-size:14px}pre::-webkit-scrollbar{height:1em}pre::-webkit-scrollbar-thumb:horizontal{border-radius:0.5em;background:rgba(0,0,0,0.4)}ul pre,ol pre{width:450px}pre.simple,.comments pre{overflow:visible;width:100%;border:none;background:transparent;background-color:transparent;box-shadow:none}pre.snippet,pre.src{border-top-style:dashed;border-bottom-style:dashed}.topic>pre:only-child{padding-bottom:14px;border-bottom:1px solid rgba(0,0,0,0.5)}blockquote{font-style:italic}table.standard{border:1px solid rgba(0,0,0,0.5);border-collapse:collapse}table.standard th{background-color:#f8f8f8;background:linear-gradient(to bottom, #f8f8f8,#f8f8f8,#f0f0f0)}table.standard td{background-color:#fff}table.standard th,table.standard td{border:1px solid rgba(0,0,0,0.5)}p.note{margin:1em;padding:1em;background:#eee;border:1px solid #ddd;box-shadow:0 8px 6px -6px rgba(0,0,0,0.4)}svg{overflow:hidden}tt,code{padding:0 2px}address{max-width:450px;text-align:right}.footer address{text-align:left}@media only screen and (max-width: 700px){.main{padding:0 10px}.topic{margin-left:10px;margin-right:10px}h2{max-width:400px}pre{font-size:10px}.width600 pre{font-size:11px}nav{font-size:12px}}@media only screen and (max-width: 600px){header,.footer{font-size:12px}h1{text-align:center;font-size:14px;padding:14px}nav span.longnav,nav form{display:none}nav ul li{width:15%}.omit-if-narrow,nav ul li.omit-if-narrow{display:none}pre{width:auto;font-size:9px}nav{font-size:10px}}form{margin:0}input[type="text"]{max-width:100%;border:1px solid rgba(0,0,0,0.7);background-color:#f8f8f4;color:#000;text-align:center;font-weight:bold}input[type="text"]:focus{background-color:#fffff4}input::-webkit-input-placeholder{color:#aaa}input::-moz-placeholder{color:#aaa}.TODO{color:#bf4040;background:#e8e3e3;border:1px solid #bf4040;margin-left:0.5ex}.DONE{color:#4040bf;background:#e3e3e8;border:1px solid #4040bf}pre.src .comment-delimiter,pre.src .nxml-comment-delimiter{color:#4488ff}pre.src .comment,pre.src .nxml-comment-content{color:#006699}pre.src .keyword{color:#406abf;font-weight:bold}pre.src .builtin{color:#508b20}pre.src .warning{color:#cc0000}pre.src .function-name{color:#268bd2;font-weight:bold}pre.src .variable-name{color:#00008b}pre.src .type{color:#6c71c4}pre.src .constant-face{color:#d33682}pre.src .doc{color:#666666;background-color:#e2e6e8}pre.src .string{color:#888888}pre.src .preprocessor{color:#859900}pre.src .negation-char,pre.src .sh-escaped-newline{color:#ff0000}pre.src .todo{color:#ffffff;background:#dc322f}pre.src .note{color:#ffffff;background:#2aa198}pre.src .hack{color:#ffffff;background:#859900}pre.src .paren{color:#a0a090;font-weight:bold}pre.src .minor-control-construct{color:#268bd2}pre.src .major-control-construct{color:#bf4040}pre.src-emacs-lisp .paren{color:#c9c9c4}pre.src-sh .string,pre.src-sh .comment{color:inherit}pre.src-python .highlight-indentation{border-right:2px solid #eeeeee}pre.src-xml .nxml-element-local-name{color:#406abf;font-weight:normal}pre.src-xml .nxml-tag-delimiter,pre.src-xml .nxml-tag-slash{color:#9cabc9;font-weight:bold}table.standard td.left,table.standard th.left{text-align:left}table.standard td.center,table.standard th.center{text-align:center}table.standard td.right,table.standard th.right{text-align:right}*[class^="section-number"]{color:#966}h2 *[class^="section-number"]{color:#e6b3b3;text-align:right;display:inline-block;margin-left:-40px;width:40px}h3 *[class^="section-number"]{color:#e6b3b3;background-color:#bf4040;border-top:1px solid black;border-bottom:1px solid black;text-shadow:0px 2px 5px rgba(0,0,0,0.8);text-rendering:optimizeLegibility;text-align:center;display:inline-block;padding:4px 0;width:40px;margin-left:-40px}@media only screen and (max-width: 700px){h3 *[class^="section-number"]{margin-left:-10px}}#table-of-contents{background-color:#fff;margin-left:40px;padding-left:40px;width:300px;float:right}#table-of-contents:after{clear:both}#table-of-contents h2{text-shadow:none;color:#000;background-color:transparent;background-image:none;padding:0;border-bottom:none;border-top:none}@media print{body{font-family:"Book Antiqua", "Times New Roman", serif;font-size:12pt;line-height:1.25}h1,h2,h3,h4,h5,h6,.footer,.divider-disqus{font-family:"Helvetica", sans-serif;font-size:12pt;text-rendering:optimizeLegibility}h1{font-size:18pt}h1 .subheading{font-size:12pt}header,h2{text-shadow:none}tt,code,kbd,samp,pre{font-family:"Courier", "Courier New", monospace;font-size:12pt}nav,.comments{display:none}}header,.footer,.divider,h2{background-image:url("/img/transparent-blob.png"),url("/img/transparent-blob.png");background-position:0 0, 16px 16px}

            
      label.ui-widget {
          font-size: 14px;
      }

      .slider .ui-slider-handle {
          height: 40px;
      }
      
      .sidebyside {
          display: block;
          margin-top: 28px;
      }
      @media only screen and (min-width: 1075px) {
          .sidebyside {
              width: 950px;
              margin-bottom: 56px;
          }
          .sidebyside .left, .sidebyside .right {
              vertical-align: top;
              margin: 0;
              display: inline-block;
              width: 450px;
          }
          .sidebyside .left {
              margin-right: 50px;
          }
      }

      #haxe\:trace { font-size: small; font-family: monospace; }
    </style><style type="text/css"></style><script type="text/javascript" async="" src="./2d Visibility_files/embed.js"></script></head><link href="./2d Visibility_files/css" rel="stylesheet" type="text/css"><body class="gameprog"><header><h1 role="banner"><div class="title">2d Visibility</div><div class="subheading">
    &nbsp; from <a href="http://www.redblobgames.com/">Red Blob Games</a></div></h1><nav role="navigation"><form action="https://www.google.com/search"><ul> <li class="nav"><a href="http://www.redblobgames.com/">Home</a></li> <li class="nav"><a href="http://simblob.blogspot.com/">Blog</a></li> <li class="nav omit-if-narrow"><a href="http://pinboard.in/u:amitp/t:gamedev/">Links</a></li> <li class="nav omit-if-narrow"><a href="https://twitter.com/redblobgames">Twitter</a></li> <li class="nav"><a rel="me" href="http://www-cs-students.stanford.edu/~amitp/">About</a></li> <li class="nav omit-if-narrow"> </li><li class="nav omit-if-narrow"><input type="search" name="q" placeholder="Search" size="8"></li></ul><input type="hidden" name="hq" value="site:www.redblobgames.com OR site:theory.stanford.edu/~amitp/ OR site:www-cs-students.stanford.edu/~amitp/ OR site:amitp.blogspot.com OR site:simblob.blogspot.com"></form></nav></header><div class="main" role="main"><x:header xmlns:x="http://local/"><link rel="stylesheet" href="./2d Visibility_files/jquery-ui-1.8.19.custom.css"></x:header><address>June 2012</address><div class="topic"><noscript>This page includes interactive diagrams that require your browser to have Canvas and Javascript enabled.</noscript><div class="sidebyside"><div class="left"><p>In a 2D top-down map it is sometimes useful to calculate which areas are visible from a given point. For example you might want to hide what’s not visible from the player’s location, or you might want to know what areas would be lit by a torch.</p><p>Drag the circle around to see what’s visible from the player’s location:</p></div><div id="maze" class="right" style="position: relative; width: 401px; height: 401px;"><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="50" height="50" style="position: absolute; cursor: move; left: 175px; top: 175px;"></canvas></div></div><p>This algorithm can also calculate what areas are lit given a light source. Run once per light, we can build a light map showing which areas are lit up. What if we put 24 lights into the above maze? <span id="maze-light-toggle"><input type="checkbox" id="maze-lights" class="ui-helper-hidden-accessible"><label for="maze-lights" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">See the light map.</label></span></p><p>The roguelike community has collected <a href="http://www.roguebasin.com/index.php?title=Field_of_Vision">several algorithms</a>, especially for grids. Subtractive algorithms start with everything visible then subtract the hidden areas; additive algorithms start with nothing visible then add the visible areas. I’ll describe an additive algorithm that works with line segments, not only solid blocks or grids.</p></div><div class="h2banner"><h2>Ray casting</h2></div><div class="topic"><div class="sidebyside"><p class="left">A simple approach is to cast rays from the center. It’s a reasonable first step to get an approximate answer:</p><div id="diagram-raycast-interval" class="right" style="position: relative; width: 401px; height: 401px;"><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="50" height="50" style="position: absolute; cursor: move; left: 70px; top: 70px;"></canvas><canvas width="60" height="60" style="position: absolute; cursor: move; left: 185px; top: 255px;"></canvas><canvas width="75" height="75" style="position: absolute; cursor: move; left: 162.5px; top: 162.5px;"></canvas></div></div><div class="sidebyside"><p class="left">To be smarter about it, let’s cast the rays only at angles where the walls begin or end. The triangles produced by these rays are the visible areas:</p><div id="diagram-raycast-endpoints" class="right" style="position: relative; width: 401px; height: 401px;"><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="50" height="50" style="position: absolute; cursor: move; left: 70px; top: 70px;"></canvas><canvas width="60" height="60" style="position: absolute; cursor: move; left: 185px; top: 255px;"></canvas><canvas width="75" height="75" style="position: absolute; cursor: move; left: 162.5px; top: 162.5px;"></canvas></div></div><p>That’s it! The algorithm is:</p><ol><li>Calculate the angles where walls begin or end.</li><li>Cast a ray from the center along each angle.</li><li>Fill in the triangles generated by those rays.</li></ol></div><div class="h2banner"><h2>Wall tracking</h2></div><div class="topic"><p>We could stop there, especially if we have a fast ray-casting algorithm that uses a spatial hash to avoid intersecting with every wall. However, a more efficient approach is to combine the ray casting and wall intersection into a single algorithm. I’ll describe here an algorithm that <em>sweeps a line around a circle</em>, hitting all the points sorted by angle; it’s also possible to <em>expand circles outwards</em>, hitting all the points sorted by radius, but I haven’t tried that approach.</p><div class="sidebyside"><div class="left"><p>For the area between consecutive rays, we want to find the <em>nearest wall</em>. This wall is lit up; all others are hidden. Our strategy will be to <em>sweep</em> around 360° and process all of the wall endpoints. As we go, we’ll keep track of the walls that intersect the sweep line.</p><p>Press Play to see the sweep of the endpoints:</p></div><div class="right"><div id="diagram-sweep-points" style="position: relative; width: 401px; height: 401px;"><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="80" height="80" style="position: absolute; cursor: move; left: 80px; top: 60px;"></canvas><canvas width="80" height="80" style="position: absolute; cursor: move; left: 140px; top: 160px;"></canvas><canvas width="75" height="75" style="position: absolute; cursor: move; left: 62.5px; top: 262.5px;"></canvas></div><div><input type="checkbox" id="diagram-sweep-points-playbutton" class="ui-helper-hidden-accessible"><label for="diagram-sweep-points-playbutton" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" role="button" aria-disabled="false" title="Play"><span class="ui-button-icon-primary ui-icon ui-icon-play"></span><span class="ui-button-text">Play</span></label><div class="slider ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all" style="display: inline-block; vertical-align: middle; margin: 10px; width: 340px; background: rgb(204, 204, 204);"><a class="ui-slider-handle ui-state-default ui-corner-all" href="http://www.redblobgames.com/articles/visibility/#" style="left: 0%;"></a></div></div></div></div><div class="sidebyside"><div class="left"><p>The next step is to keep track of which walls the sweep ray passes through. <em>Only the nearest wall is visible.</em> How do you figure out which wall is nearest? The simplest thing is to calculate the distance from the center to the wall. However, this approach doesn’t work well if the walls are of different sizes, so the demo uses a slightly more complicated approach, which I won’t explain here.</p><p>Press Play to see the sweep with the nearest wall drawn in white and the other walls drawn in black.</p></div><div class="right"><div id="diagram-sweep-segments" style="position: relative; width: 401px; height: 401px;"><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="80" height="80" style="position: absolute; cursor: move; left: 80px; top: 60px;"></canvas><canvas width="80" height="80" style="position: absolute; cursor: move; left: 140px; top: 160px;"></canvas><canvas width="75" height="75" style="position: absolute; cursor: move; left: 62.5px; top: 262.5px;"></canvas></div><div><input type="checkbox" id="diagram-sweep-segments-playbutton" class="ui-helper-hidden-accessible"><label for="diagram-sweep-segments-playbutton" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" role="button" aria-disabled="false" title="Play"><span class="ui-button-icon-primary ui-icon ui-icon-play"></span><span class="ui-button-text">Play</span></label><div class="slider ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all" style="display: inline-block; vertical-align: middle; margin: 10px; width: 340px; background: rgb(204, 204, 204);"><a class="ui-slider-handle ui-state-default ui-corner-all" href="http://www.redblobgames.com/articles/visibility/#" style="left: 0%;"></a></div></div></div></div><div class="sidebyside"><div class="left"><p>Whenever the nearest wall ends, or if a new wall is nearer than the others, we create a triangle showing a visible region. The union of these triangles is the area that is visible from the central point.</p></div><pre class="snippet right">var endpoints;      # list of endpoints, sorted by angle
var open = [];      # list of walls, sorted by distance

loop over endpoints:
    remember which wall is nearest
    add any walls that BEGIN at this endpoint to 'walls'
    remove any walls that END at this endpoint from 'walls'
    
    SORT the open list
    
    if the nearest wall changed:
        fill the current triangle and begin a new one</pre></div><!-- this should go on the left --><p>Note that creating a triangle involves intersecting the previously active wall with the sweep ray. As a result, the new edge of the triangle may be longer or shorter than the sweep ray, and the far edge of the triangle may be shorter than the previously active wall.</p></div><div class="h2banner"><h2>Playground</h2></div><div class="topic"><div class="sidebyside"><p class="left">Here’s a playground with more blocks. Drag blocks into the grid area. Press play/pause to see the algorithm in action, or drag the center point around to see what would be visible as the player walks around.</p><div class="right"><div id="diagram-playground" style="position: relative; width: 501px; height: 401px;"><canvas width="501" height="401" style="position: absolute;"></canvas><canvas width="501" height="401" style="position: absolute;"></canvas><canvas width="40" height="40" style="position: absolute; cursor: move; left: 410px; top: 10px;"></canvas><canvas width="40" height="40" style="position: absolute; cursor: move; left: 450px; top: 60px;"></canvas><canvas width="40" height="40" style="position: absolute; cursor: move; left: 410px; top: 110px;"></canvas><canvas width="40" height="40" style="position: absolute; cursor: move; left: 450px; top: 160px;"></canvas><canvas width="60" height="60" style="position: absolute; cursor: move; left: 410px; top: 210px;"></canvas><canvas width="60" height="60" style="position: absolute; cursor: move; left: 430px; top: 280px;"></canvas><canvas width="20" height="20" style="position: absolute; cursor: move; left: 410px; top: 350px;"></canvas><canvas width="20" height="20" style="position: absolute; cursor: move; left: 440px; top: 370px;"></canvas><canvas width="20" height="20" style="position: absolute; cursor: move; left: 470px; top: 350px;"></canvas><canvas width="75" height="75" style="position: absolute; cursor: move; left: 162.5px; top: 162.5px;"></canvas></div><div><input type="checkbox" id="diagram-playground-playbutton" class="ui-helper-hidden-accessible"><label for="diagram-playground-playbutton" aria-pressed="false" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" role="button" aria-disabled="false" title="Play"><span class="ui-button-icon-primary ui-icon ui-icon-play"></span><span class="ui-button-text">Play</span></label><div class="slider ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all" style="display: inline-block; vertical-align: middle; margin: 10px; width: 340px; background: rgb(204, 204, 204);"><a class="ui-slider-handle ui-state-default ui-corner-all" href="http://www.redblobgames.com/articles/visibility/#" style="left: 100%;"></a></div></div></div></div><div id="haxe:trace"></div></div><div class="h2banner"><h2>Combining outputs</h2></div><div class="topic"><p>We can use set operations to combine outputs of this algorithm in interesting ways. These are implemented either as boolean operations in algorithms that analyze the output, or as bitmap operations in algorithms that render the output.</p><h3>Player vision</h3><p>The simplest operation is to limit the player’s vision by intersecting the output with the limit of visibility. For example, intersect the output of the algorithm with a circle to limit the radius you can see. Intersect with a gradient-filled circle to make the light fall off with distance. Intersect with a cone to build a “flashlight” effect that lets you see farther in front of you but not much behind you (see the trailed for <a href="http://www.tuaw.com/2012/04/16/phil-hasseys-anathema-mines-renamed-dynamite-jack-gets-a-trail/">Dynamite Jack</a> for an example of this).</p><p>Player vision would also look better if it took into account both eyes instead of treating the player as a single point. I’d expect that you can take the union of the visibility output from each eye but I haven’t tried this.</p><h3>Map objects</h3><p>Visibility can also be used for calculating what areas a torch lights up. The demo at the top of the page first takes the union of the areas lit up by each torch, then intersects that with the area the player can see. (Note that this algorithm produces hard shadows and you’ll have to post-process the output to get soft shadows.)</p><p>The same calculation could be used for determining what areas a security camera can see, what’s protected by a shield, or what’s magic objects are close enough to give you a bonus or curse.</p><h3>AI behaviors</h3><div class="sidebyside"><div class="left"><p>Visibility can also be used to build AI behaviors.</p><p>For example, let’s suppose the enemy AI wants to throw a grenade to hit one of the players, but also wants to stand in a place where the players can’t shoot back. Grenades need to be close enough to hit the player, and also not behind an obstruction.</p><p>This diagram shows the map annotations an AI unit might calculate:</p></div><div class="right"><div id="grenade" style="position: relative; width: 401px; height: 401px;"><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="401" height="401" style="position: absolute;"></canvas><canvas width="50" height="50" style="position: absolute; cursor: move; left: 175px; top: 175px;"></canvas></div></div></div><p>Grenades thrown into purple areas will successfully hit a player. Yellow and purple areas are dangerous to stand in; the player can shoot the AI unit from there. The AI needs to stand in a safe (dark blue) zone and throw a grenade into a purple zone, then take cover. How do you calculate cover? Run the visibility algorithm again from the place the AI plans to throw the grenade, making cabinets and tables block line of sight.</p></div><div class="h2banner"><h2>Implementation</h2></div><div class="topic"><p>I have written a <a href="http://www.redblobgames.com/articles/visibility/Visibility.hx">Haxe 3 implementation</a> of this algorithm, open source under the Apache v2 license (similar to MIT and BSD, it can be used in commercial projects). <a href="http://haxe.org/">Haxe</a> code can be compiled into Javascript, Actionscript, C++, Java, C#, or PHP. I compiled it into Javascript for this web page and compiled it into Flash for some of my other projects. I’ve compiled it into these languages:</p><ul><li><a href="http://www.redblobgames.com/articles/visibility/as3-version.zip">Actionscript</a>; readable, since Actionscript is not too different from Haxe</li><li><a href="./2d Visibility_files/_visibility.js">Javascript</a> (used for the demos on this page); mostly readable.</li><li><a href="http://www.redblobgames.com/articles/visibility/java-version.zip">Java</a>; mildly readable but not great.</li><li><a href="http://www.redblobgames.com/articles/visibility/csharp-version.zip">C#</a>; mildly readable but not great. Roy Triesscheijn has a better version <a href="http://roy-t.nl/index.php/2014/02/27/2d-lighting-and-shadows-preview/">here</a>.</li></ul><p>Wade Tritschler suggests <a href="http://www.redblobgames.com/articles/visibility/#comment-850486470">porting by hand</a> is going to generate cleaner results than using the Haxe output. I agree. You’ll also understand the algorithm better if you convert the code by hand.</p><p>Although the main part of the algorithm is CPU bound, the GPU could be used for triangle rendering to a bitmap and compositing operations for combining bitmap outputs. (A boolean AND operation becomes a bitmap multiply; a boolean OR becomes a bitmap add and clamp.) The performance hasn’t been enough of a problem in my projects so I haven’t built a GPU version. If your game is CPU bound, consider using a subtractive algorithm (instead of the additive one shown here), rendering the shadow of each line segment as a quad. It will increase the rendering load on the GPU but it doesn’t require sorting on the CPU. If fill rate is an issue, consider rendering a light bitmap that’s at a lower resolution than the game screen, and scaling it up.</p></div><div class="h2banner"><h2>Related</h2></div><div class="topic"><p><a href="http://ncase.me/sight-and-light/">Sight and Light</a> covers the visibility problem; on <a href="http://simblob.blogspot.com/2012/07/2d-visibility.html">my blog post</a> I have more links. <a href="http://journal.stuffwithstuff.com/2015/09/07/what-the-hero-sees/">Munificent covers visibility algorithms optimized for grids</a>, with interactive diagrams and sample code. <a href="https://briangordon.github.io/2014/08/the-skyline-problem.html">The Skyline Problem</a> is similar to 2d visibility, except it’s in cartesian coordinates instead of polar coordinates. There’s also the <a href="http://en.wikipedia.org/wiki/Art_gallery_problem">art gallery problem</a> about placing multiple guards in the environment so that they can see the every area of the map. I’m making a list on Trello of <a href="https://trello.com/c/m0yhEv6U/37-visibility-version-2">possible future updates to this page</a>.</p><!-- other impl: https://code.google.com/p/straightedge/ --><!-- other impl: https://code.google.com/p/visibility-polygon-js/ --></div></div><div class="divider"></div><div class="divider-disqus" style="font-size:large">
            Email me at
            
            <a class="email" href="mailto:redblobgames@gmail.com">redblobgames@gmail.com</a>,
                or tweet to <a href="http://twitter.com/redblobgames">@redblobgames</a>,
              
            or post a public comment:
          </div><div class="comments" role="complementary"><div id="disqus_thread" class="main"><iframe id="dsq-app1" name="dsq-app1" allowtransparency="true" frameborder="0" scrolling="no" tabindex="0" title="Disqus" width="100%" src="about:blank" style="width: 100% !important; border: none !important; overflow: hidden !important; height: 0px !important;"></iframe></div><script>
              (function() {
              var dsq = document.createElement('script');
              dsq.type = 'text/javascript'; dsq.async = true;
              
                  dsq.src = 'http://redblobgames.disqus.com/embed.js';
                
              if (document.location.hostname != 'localhost') (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
              })();
            </script><noscript>&lt;a href="http://redblobgames.disqus.com/?url=ref"&gt;View the discussion thread.&lt;/a&gt;</noscript></div><div class="footer" role="contentinfo"><div style="float:left;width:300px;margin-right:40px"><address>
		  Copyright © 2015
                  <a rel="author home copyright" href="http://www.redblobgames.com/">Red Blob Games</a></address></div><div style="text-align:right">
	    &nbsp;<!-- it's not clear to me whether I should put scripts at the bottom or top .. --><script type="text/javascript" src="./2d Visibility_files/jquery-1.7.2.min.js"></script><script type="text/javascript" src="./2d Visibility_files/jquery-ui-1.8.19.custom.min.js"></script><script type="text/javascript" src="./2d Visibility_files/_visibility.js"></script><script type="text/javascript" src="./2d Visibility_files/demo-canvas.js"></script> Created 13 Mar 2012 with <a href="http://en.wikipedia.org/wiki/Haxe">Haxe</a>, JQuery, and JQuery-UI; &nbsp;<!-- Created: 13 Mar 2012 --><!-- hhmts start -->Last modified: 04 Oct 2015<!-- hhmts end --></div><br style="clear:both"><!-- Start of counters --><script><!--
                  var sc_project=417499;
                  var sc_invisible=1;
                  var sc_security="";
(function() {
      var script = document.createElement('script');
      script.type = 'text/javascript'; script.async = true;
      script.src = 'http://statcounter.com/counter/counter_xhtml.js';
      if (document.location.hostname != 'localhost') document.getElementsByTagName('body')[0].appendChild(script);
  })();
                //--></script><noscript>&lt;div class="statcounter"&gt;&lt;a class="statcounter" href="http://statcounter.com/"&gt;&lt;img class="statcounter" src="http://c.statcounter.com/417499/0//1/" alt=""&gt;&lt;/a&gt;&lt;/div&gt;</noscript><script>
var _gap = _gap || [];
_gap.push(['_setAccount', 'UA-79181-1']);
_gap.push(['_setDomainName', 'redblobgames.com']);
_gap.push(['_setAllowLinker', true]);
_gap.push(['_trackPageview']);
_gap.push(['_gapTrackBounceViaTime', 30]);
_gap.push(['_gapTrackBounceViaScroll', 25]);
_gap.push(['_gapTrackReads', 60, 10]);
_gap.push(['_gapTrackLinkClicks']);
if (document.location.hostname != 'localhost') (function() {
    var gap = document.createElement('script');
    gap.async = true;
    gap.type = 'text/javascript';
    gap.src = '/js/gap.min.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(gap, s);
})();
              </script><!-- End of counters --></div><script type="text/javascript" async="" src="./2d Visibility_files/counter_xhtml.js"></script>
</body></html>